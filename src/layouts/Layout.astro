---
import "@/styles/global.scss";
import "@/styles/theme.scss";
import "@/styles/typography.scss";
import Header from "@/components/layout/Header.astro";
import Footer from "@/components/layout/Footer.astro";
import { baseUrl, BLOG_NAME } from "@/constants";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href={`${baseUrl}/favicon.svg`} />
    <meta name="generator" content={Astro.generator} />
    <title>{BLOG_NAME} universe</title>

    {/* ✅ CSS 적용 전에 테마부터 세팅 */}
    <script is:inline>
      (() => {
        // 테마를 저장할 키를 정의합니다.
        const storageKey = "soovoxx-theme";

        // 사용자의 시스템 설정에서 다크 모드 선호 여부를 확인합니다.
        const prefersDark = window.matchMedia(
          "(prefers-color-scheme: dark)",
        ).matches;

        // 로컬 스토리지에서 저장된 테마를 가져옵니다.
        const savedTheme = localStorage.getItem(storageKey);

        // 저장된 테마가 없으면, 시스템 설정에 따라 기본 테마를 결정합니다.
        const theme = savedTheme || (prefersDark ? "dark" : "light");

        // 결정된 테마를 문서의 데이터 속성에 설정합니다.
        document.documentElement.dataset.theme = theme;
      })();
    </script>
  </head>

  <body>
    <div class="page">
      <Header />

      <main class="content">
        <slot />
      </main>

      <Footer />
    </div>

    {/* ✅ 토글 로직은 아래에서 */}
    <script>
      const storageKey = "soovoxx-theme";
      const toggleBtn = document.getElementById("themeToggle");

      const setLabel = (theme: any) => {
        toggleBtn?.setAttribute(
          "aria-label",
          `Switch to ${theme === "light" ? "dark" : "light"} mode`,
        );
      };

      const applyTheme = (theme: any) => {
        document.documentElement.dataset.theme = theme;
        localStorage.setItem(storageKey, theme);
        setLabel(theme);
      };

      // 초기값은 head 쪽에서 이미 세팅했으니, 여기서는 label만 맞춰주면 충분
      const currentTheme =
        document.documentElement.dataset.theme ||
        (window.matchMedia("(prefers-color-scheme: dark)").matches
          ? "dark"
          : "light");
      setLabel(currentTheme);

      toggleBtn?.addEventListener("click", () => {
        const next =
          document.documentElement.dataset.theme === "light" ? "dark" : "light";
        applyTheme(next);
      });
    </script>

    {/* 코드 블록 복사 버튼 */}
    <script is:inline>
      (() => {
        const codeBlocks = Array.from(document.querySelectorAll("pre > code"));
        if (!codeBlocks.length) return;

        const copyIcon = `
          <svg aria-hidden="true" focusable="false" class="icon" viewBox="0 0 24 24">
            <path d="M9 3h10a2 2 0 0 1 2 2v12h-2V5H9V3Zm-4 4h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Zm0 2v10h10V9H5Z" fill="currentColor"/>
          </svg>`;
        const checkIcon = `
          <svg aria-hidden="true" focusable="false" class="icon" viewBox="0 0 24 24">
            <path d="m9.6 16.2-3.8-3.8 1.4-1.4 2.4 2.4 7.2-7.2 1.4 1.4-8.6 8.6Z" fill="currentColor"/>
          </svg>`;

        codeBlocks.forEach((codeEl) => {
          const pre = codeEl.parentElement;
          if (!pre || pre.querySelector(".code-copy")) return;

          pre.dataset.codeBlock = "true";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "code-copy";
          btn.innerHTML = `${copyIcon}<span class="sr-only">코드 복사</span>`;
          btn.setAttribute("aria-label", "코드 복사");

          btn.addEventListener("click", async () => {
            const text = codeEl.innerText;
            try {
              await navigator.clipboard.writeText(text);
              btn.innerHTML = `${checkIcon}<span class="sr-only">복사 완료</span>`;
              btn.classList.add("copied");
            } catch (err) {
              btn.innerHTML = `${copyIcon}<span class="sr-only">복사 실패</span>`;
              console.error("Copy failed", err);
            } finally {
              setTimeout(() => {
                btn.innerHTML = `${copyIcon}<span class="sr-only">코드 복사</span>`;
                btn.classList.remove("copied");
              }, 1400);
            }
          });

          pre.appendChild(btn);
        });
      })();
    </script>
  </body>
</html>

<style lang="scss">
  .page {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }

  main.content {
    padding: 38px 0 56px;
    flex: 1;
    width: min(1100px, 80vw);
    margin: 0 auto;
    position: relative;
  }

  @media (max-width: 720px) {
    main.content {
      width: 90vw;
    }
  }

  :global(pre[data-code-block]) {
    position: relative;
  }

  :global(pre[data-code-block] .code-copy) {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 6px 10px;
    border-radius: 10px;
    border: 1px solid #24292e;
    background: #24292e;
    color: #ffffff;
    cursor: pointer;
    font-size: 0.85rem;
    line-height: 1;
    box-shadow: 0 10px 24px var(--shadow);
    transition:
      transform 0.15s ease,
      box-shadow 0.2s ease,
      background 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  :global(pre[data-code-block] .code-copy:hover) {
    transform: translateY(-1px);
    box-shadow: 0 14px 28px var(--shadow);
    background: #2f3842;
  }

  :global(pre[data-code-block] .code-copy.copied) {
    background: #2f3842;
    border-color: #2f3842;
  }

  :global(pre[data-code-block] .code-copy .icon) {
    width: 16px;
    height: 16px;
  }

  :global(pre[data-code-block] .code-copy .sr-only) {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
</style>
