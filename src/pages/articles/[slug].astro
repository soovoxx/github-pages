---
import { baseUrl } from '../../constants';
import Layout from '../../layouts/Layout.astro';
import '../../styles/markdown.css'
import { getAdjacentPosts } from '../../lib';
import { parsePubDate } from '../../lib/post';
import type { Post } from '../../types';

export async function getStaticPaths() {
  const posts: Post[] = Object.values(import.meta.glob('../../content/posts/*.md', { eager: true }));

  return posts
    .filter((post) => Boolean(post.frontmatter.slug))
    .map((post) => ({
      params: { slug: post.frontmatter.slug },
      props: { post },
    }));
}

const { post } = Astro.props;
const { Content, frontmatter: { pubDate, title, summary } } = post;
const tags = post.frontmatter.tags || [];
const headings = post.getHeadings();
console.log(post.getHeadings());
const tocHeadings = headings.filter(({ depth }) => depth >= 2 && depth <= 4);
const getTocPadding = (depth: number) => 8 + Math.max(0, depth - 2) * 12;

const {prevPost, nextPost} = getAdjacentPosts(post.frontmatter.slug)
const parsedPubDate = parsePubDate(pubDate);
---

<Layout>
  <div class="post-layout">
    <article class="post">
      <p class="eyebrow">{parsedPubDate.toLocaleDateString('ko-KR')}</p>
      <h1 class="title">{title}</h1>
      <div class="tags">
        {tags.map((t) => (
          <a class="tag" href={`${baseUrl}/tags/${encodeURIComponent(t)}`}>#{t}</a>
        ))}
      </div>
      <div class="content">
        <Content />
      </div>
      {(prevPost || nextPost) && (
        <nav class="post-nav" aria-label="Post navigation">
          {prevPost ? (
            <a class="nav-link" href={`${baseUrl}/articles/${prevPost.slug}`}>
              <span class="nav-label">이전 글</span>
              <span class="nav-title">{prevPost.title}</span>
            </a>
          ) : (
            <span></span>
          )}
          {nextPost ? (
            <a class="nav-link" href={`${baseUrl}/articles/${nextPost.slug}`}>
              <span class="nav-label">다음 글</span>
              <span class="nav-title">{nextPost.title}</span>
            </a>
          ) : (
            <span></span>
          )}
        </nav>
      )}
    </article>

    {tocHeadings.length > 0 && (
      <aside class="toc" aria-label="On this page">
        <ul class="toc-list">
          {tocHeadings.map((heading) => (
            <li class="toc-item">
              <a
                class="toc-link"
                style={`padding-left: ${getTocPadding(heading.depth)}px`}
                href={`#${heading.slug}`}
              >
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </aside>
    )}
  </div>
</Layout>

<script is:inline>
  const tocLinks = Array.from(document.querySelectorAll('.toc a'));
  const headings = Array.from(document.querySelectorAll('.content :is(h2, h3, h4)')).filter(
    (heading) => heading.id,
  );

  if (tocLinks.length && headings.length) {
    const linkTargets = tocLinks.map((link) => ({
      link,
      id: decodeURIComponent(link.hash.slice(1)),
    }));

    const scrollOffset = 80;

    let lastActiveId = '';

    const setActive = (id) => {
      if (id === lastActiveId) return;
      lastActiveId = id;
      linkTargets.forEach(({ link, id: targetId }) => {
        const isActive = targetId === id;
        link.classList.toggle('active', isActive);
        if (isActive) {
          link.setAttribute('aria-current', 'true');
        } else {
          link.removeAttribute('aria-current');
        }
      });
    };

    const getOffsetTop = (el) => el.getBoundingClientRect().top + window.scrollY;
    const scrollToHeading = (id) => {
      const target = document.getElementById(id);
      if (!target) return;
      const targetTop = Math.max(0, getOffsetTop(target) - scrollOffset);
      window.scrollTo({ top: targetTop, behavior: 'smooth' });
    };

    const updateActive = () => {
      const offsetY = window.scrollY + scrollOffset + 20;
      let currentId = headings[0]?.id;

      for (const heading of headings) {
        if (getOffsetTop(heading) <= offsetY) {
          currentId = heading.id;
        } else {
          break;
        }
      }

      if (currentId) setActive(currentId);
    };

    let ticking = false;
    window.addEventListener(
      'scroll',
      () => {
        if (!ticking) {
          window.requestAnimationFrame(() => {
            updateActive();
            ticking = false;
          });
          ticking = true;
        }
      },
      { passive: true },
    );

    window.addEventListener('resize', updateActive);
    updateActive();

    const hash = decodeURIComponent(window.location.hash.replace('#', ''));
    if (hash) setActive(hash);

    linkTargets.forEach(({ link, id }) => {
      link.addEventListener('click', (event) => {
        event.preventDefault();
        scrollToHeading(id);
        setActive(id);
        history.replaceState(null, '', window.location.pathname + window.location.search);
      });
    });
  }
</script>

<style lang="scss">
  :global(html) {
    scroll-behavior: smooth;
  }

  .post-layout {

    .post {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      padding: 30px 44px;
      border-radius: 24px;
      border: 1px solid color-mix(in srgb, var(--text) 10%, transparent);
      box-shadow: 0 18px 40px var(--shadow);

      h1 {
        margin: 15px 0;
      }

      .tags {
        display: flex;
        gap: 5px;
        justify-content: flex-end;
        padding: 10px 0;
        color: var(--muted);

        .tag {
          font-size: 0.9em;
          padding: 3px 6px;
          background-color: color-mix(in srgb, var(--text) 5%, transparent);
          border-radius: 10px;
          letter-spacing: 0.05em;
          cursor: pointer;
          text-decoration: none;
          color: inherit;
        }
      }

      .content {
        :is(h2, h3, h4) {
          scroll-margin-top: 120px;
        }
      }

      .post-nav {
        margin-top: 28px;
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;

        .nav-link {
          display: grid;
          gap: 4px;
          padding: 12px 14px;
          background: var(--panel);
          border: 1px solid color-mix(in srgb, var(--text) 10%, transparent);
          border-radius: 12px;
          color: var(--text);
          text-decoration: none;
          box-shadow: 0 10px 24px var(--shadow);
          transition: transform 0.15s ease, box-shadow 0.2s ease;

          &:hover {
            transform: translateY(-2px);
            box-shadow: 0 14px 30px var(--shadow);
          }

          .nav-label {
            font-size: 0.9rem;
            color: var(--muted);
          }

          .nav-title {
            font-weight: 700;
          }
        }
      }
    }

    .toc {
      position: fixed;
      top: 120px;
      align-self: start;
      border-radius: 16px;
      padding: 4px;
      max-height: calc(100vh - 160px);
      overflow: auto;
      right: 3%;
      font-size: 12px;
      min-width: 290px;
      max-width: 290px;

      .toc-title {
        margin: 0 0 8px;
        font-weight: 700;
        font-size: 0.95rem;
        color: var(--muted);
        letter-spacing: 0.02em;
      }

        .toc-list {
          list-style: none;
          padding: 0;
          margin: 0;
          display: grid;
          grid-template-columns: 1fr;

          .toc-item {
            line-height: 1.2;
            min-width: 0;
          }
        }

        .toc-link {
          display: block;
          padding: 3px;
          width: 100%;
          max-width: 100%;
          box-sizing: border-box;
          min-width: 0;
          overflow: hidden;
          text-overflow: ellipsis;
          white-space: nowrap;
          border-radius: 10px;
          color: var(--muted);
          text-decoration: none;
          border: 1px solid transparent;
          transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;

          &:hover {
            color: var(--text);
            border-color: color-mix(in srgb, var(--accent) 45%, transparent);
            background: color-mix(in srgb, var(--panel) 98%, transparent);
          }

          &.active {
            color: var(--text);
            border-color: color-mix(in srgb, var(--accent) 60%, transparent);
            background: color-mix(in srgb, var(--accent) 12%, var(--panel));
            font-weight: 700;
          }
        }
    }
  }

  @media (max-width: 1080px) {
    .post-layout {
      grid-template-columns: 1fr;

      .toc {
        position: static;
        order: -1;
        max-height: none;
        box-shadow: 0 10px 24px var(--shadow);
      }
    }
  }

  @media (max-width: 900px) {
    .post-layout {
      .post {
        padding: 22px;
      }

      .toc-link {
        padding: 8px 10px;
      }
    }
  }
</style>
